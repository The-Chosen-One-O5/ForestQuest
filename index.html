<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forest Quest</title>
    <style>
        body {
            background: url('forest.jpg') no-repeat center center fixed;
            background-size: cover;
            font-family: Arial, sans-serif;
            color: #333;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .stats, .add-task, .task-list, .shop {
            margin-bottom: 20px;
        }

        .popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
        }

        .popup-content {
            background: white;
            margin: 50px auto;
            padding: 20px;
            width: 80%;
            max-width: 500px;
            border-radius: 10px;
        }

        .shop-items {
            display: flex;
            gap: 20px;
        }

        .shop-item {
            text-align: center;
        }

        .shop-item img {
            width: 50px;
            height: 50px;
        }

        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }

        button:hover {
            background: #45a049;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .notifications {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 300px;
        }

        .notification {
            background: #f44336;
            color: white;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
        }

        .dashboard {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Stats -->
        <div class="stats">
            <h2>Stats</h2>
            <p>Level: <span id="level">1</span></p>
            <p>Coins: <span id="coins">0</span></p>
            <p>Tasks Completed: <span id="tasks-completed">0</span></p>
            <p>Streak: <span id="streak">0 days</span></p>
            <button id="targets-btn">View Targets</button>
            <button id="schedule-btn">View Schedule</button>
        </div>

        <!-- Add Task -->
        <div class="add-task">
            <h2>Add Task</h2>
            <form id="add-task-form">
                <input type="text" id="task-name" placeholder="Task Name" required>
                <input type="datetime-local" id="task-deadline" required>
                <select id="task-difficulty">
                    <option value="easy">Easy (50 coins)</option>
                    <option value="medium">Medium (100 coins)</option>
                    <option value="hard">Hard (150 coins)</option>
                </select>
                <button type="submit">Add Task</button>
            </form>
        </div>

        <!-- Task List -->
        <div class="task-list">
            <h2>Tasks</h2>
            <ul id="tasks"></ul>
        </div>

        <!-- Shop -->
        <div class="shop">
            <h2>Shop</h2>
            <div class="shop-items">
                <div class="shop-item">
                    <img src="tree.png" alt="New Tree">
                    <p>New Tree - 500 coins</p>
                    <button class="buy-btn" data-item="tree">Buy</button>
                </div>
                <div class="shop-item">
                    <img src="bird.png" alt="Bird">
                    <p>Bird - 300 coins</p>
                    <button class="buy-btn" data-item="bird">Buy</button>
                </div>
            </div>
        </div>

        <!-- Test Marks Graph -->
        <div class="graph">
            <h2>Test Marks</h2>
            <form id="add-mark-form">
                <input type="number" id="test-mark" placeholder="Score" required>
                <input type="number" id="test-total" placeholder="Total" required>
                <button type="submit">Add Mark</button>
            </form>
            <input type="number" id="goal-score" placeholder="Set Goal Score">
            <button id="set-goal">Set Goal</button>
            <canvas id="marks-graph" width="300" height="200"></canvas>
            <p>Prediction: <span id="score-prediction">N/A</span></p>
        </div>

        <!-- Targets Popup -->
        <div class="popup" id="targets-popup">
            <div class="popup-content">
                <h2>Subject Progress</h2>
                <button id="toggle-knowledge-tree">Toggle Knowledge Tree</button>
                <table id="targets-table">
                    <thead>
                        <tr>
                            <th>Subject</th>
                            <th>Progress</th>
                            <th>Challenge</th>
                        </tr>
                    </thead>
                    <tbody id="targets-body"></tbody>
                </table>
                <canvas id="knowledge-tree" width="400" height="300" style="display: none;"></canvas>
                <button class="close-btn" id="close-targets">Close</button>
            </div>
        </div>

        <!-- Schedule Popup -->
        <div class="popup" id="schedule-popup">
            <div class="popup-content">
                <h2>Schedule</h2>
                <form id="add-schedule-form">
                    <input type="time" id="schedule-time" required>
                    <input type="text" id="schedule-activity" placeholder="Activity" required>
                    <input type="number" id="schedule-duration" placeholder="Duration (min)" required>
                    <button type="submit">Add Block</button>
                </form>
                <table class="schedule-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Activity</th>
                            <th>Duration</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="schedule-body"></tbody>
                </table>
                <div class="pomodoro-timer">
                    <h3>Pomodoro Timer</h3>
                    <p id="timer-display">25:00</p>
                    <button id="start-pomodoro">Start</button>
                    <button id="stop-pomodoro">Stop</button>
                </div>
                <button class="close-btn" id="close-schedule">Close</button>
            </div>
        </div>
    </div>

    <!-- Dashboard (Toggles with 'Z') -->
    <div class="dashboard" id="dashboard">
        <h2>Dashboard</h2>
        <p>Level: <span id="dashboard-level">1</span></p>
        <p>Coins: <span id="dashboard-coins">0</span></p>
        <p>Active Tasks: <span id="dashboard-tasks">0</span></p>
        <p>Streak: <span id="dashboard-streak">0 days</span></p>
        <button id="shop-link">Shop</button>
        <button id="schedule-link">Schedule</button>
        <button id="targets-link">Targets</button>
    </div>

    <!-- Notifications -->
    <div class="notifications" id="notifications"></div>

    <script>
        // Game State
        let gameState = {
            coins: 0,
            level: 1,
            tasksCompleted: 0,
            tasks: new Map(),
            streak: { current: 0, lastCompletionDate: null },
            prestige: 0,
            multipliers: [],
            achievements: [],
            schedule: [],
            pomodoro: { active: false, timeLeft: 0, break: false },
            notifications: [],
            subjects: new Map([['Physics', 0], ['Chemistry', 0], ['Math', 0]]),
            marks: [],
            goalScore: null
        };

        // Load from localStorage
        function loadGameState() {
            const saved = localStorage.getItem('forestQuest');
            if (saved) {
                const parsed = JSON.parse(saved);
                gameState = {
                    ...parsed,
                    tasks: new Map(parsed.tasks || []),
                    subjects: new Map(parsed.subjects || [['Physics', 0], ['Chemistry', 0], ['Math', 0]]),
                    marks: parsed.marks || [],
                    streak: parsed.streak || { current: 0, lastCompletionDate: null },
                    multipliers: parsed.multipliers || [],
                    achievements: parsed.achievements || [],
                    schedule: parsed.schedule || [],
                    pomodoro: parsed.pomodoro || { active: false, timeLeft: 0, break: false },
                    notifications: parsed.notifications || []
                };
            }
        }

        // Save to localStorage
        function saveGameState() {
            const toSave = {
                ...gameState,
                tasks: Array.from(gameState.tasks.entries()),
                subjects: Array.from(gameState.subjects.entries())
            };
            localStorage.setItem('forestQuest', JSON.stringify(toSave));
        }

        // Utility Functions
        function generateTaskId() {
            return 'task_' + Math.random().toString(36).substr(2, 9);
        }

        function addCoins(amount) {
            let multiplier = 1 + (gameState.prestige * 0.1);
            gameState.multipliers.forEach(m => {
                if (Date.now() < m.expires) multiplier *= m.multiplier;
            });
            gameState.coins += amount * multiplier;
            if (gameState.coins >= gameState.level * 100) levelUp();
            saveGameState();
            updateUI();
        }

        function levelUp() {
            gameState.level++;
            if (gameState.level >= 10) {
                if (confirm('Prestige? Reset for a 10% coin bonus.')) {
                    gameState.coins = 0;
                    gameState.level = 1;
                    gameState.prestige++;
                    gameState.tasks.clear();
                }
            }
            addNotification('Level Up! You are now Level ' + gameState.level);
        }

        // UI Updates
        function updateUI() {
            document.getElementById('level').textContent = gameState.level;
            document.getElementById('coins').textContent = Math.floor(gameState.coins);
            document.getElementById('tasks-completed').textContent = gameState.tasksCompleted;
            document.getElementById('streak').textContent = gameState.streak.current + ' days';
            document.getElementById('dashboard-level').textContent = gameState.level;
            document.getElementById('dashboard-coins').textContent = Math.floor(gameState.coins);
            document.getElementById('dashboard-tasks').textContent = gameState.tasks.size;
            document.getElementById('dashboard-streak').textContent = gameState.streak.current + ' days';
            renderTasks();
            renderTargets();
            renderSchedule();
            renderGraph();
            renderNotifications();
        }

        // Tasks and Deadlines
        document.getElementById('add-task-form').addEventListener('submit', e => {
            e.preventDefault();
            const name = document.getElementById('task-name').value;
            const deadline = document.getElementById('task-deadline').value;
            const difficulty = document.getElementById('task-difficulty').value;
            const coinReward = { easy: 50, medium: 100, hard: 150 }[difficulty];
            const id = generateTaskId();
            gameState.tasks.set(id, { id, name, deadline, difficulty, coinReward, created: new Date().toISOString() });
            document.getElementById('add-task-form').reset();
            saveGameState();
            updateUI();
        });

        function renderTasks() {
            const ul = document.getElementById('tasks');
            ul.innerHTML = '';
            gameState.tasks.forEach(task => {
                const li = document.createElement('li');
                li.innerHTML = `${task.name} (Due: ${new Date(task.deadline).toLocaleString()}, Difficulty: ${task.difficulty}) <button data-id="${task.id}">Complete</button>`;
                ul.appendChild(li);
            });
            ul.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', () => completeTask(btn.dataset.id));
            });
        }

        function completeTask(taskId) {
            const task = gameState.tasks.get(taskId);
            if (!task) return;
            const now = new Date();
            if (new Date(task.deadline) >= now) {
                const today = now.toDateString();
                if (gameState.streak.lastCompletionDate !== today) {
                    const yesterday = new Date(now.setDate(now.getDate() - 1)).toDateString();
                    if (gameState.streak.lastCompletionDate === yesterday) {
                        gameState.streak.current++;
                        if (gameState.streak.current % 5 === 0) addCoins(50);
                    } else {
                        gameState.streak.current = 1;
                    }
                    gameState.streak.lastCompletionDate = today;
                }
            } else {
                gameState.streak.current = 0;
            }
            addCoins(task.coinReward);
            gameState.tasksCompleted++;
            gameState.tasks.delete(taskId);
            scheduleTaskIntegration();
            saveGameState();
            updateUI();
        }

        // Shop
        document.querySelectorAll('.buy-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const item = btn.dataset.item;
                const cost = item === 'tree' ? 500 : 300;
                if (gameState.coins >= cost) {
                    gameState.coins -= cost;
                    document.body.style.backgroundImage = `url('${item}.jpg')`;
                    addNotification(`Purchased ${item}!`);
                    if (item === 'bird') {
                        gameState.multipliers.push({ multiplier: 2, expires: Date.now() + 24 * 60 * 60 * 1000 });
                    }
                    saveGameState();
                    updateUI();
                } else {
                    addNotification('Not enough coins!');
                }
            });
        });

        // Subject Progress
        function renderTargets() {
            const tbody = document.getElementById('targets-body');
            tbody.innerHTML = '';
            gameState.subjects.forEach((progress, subject) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${subject}</td>
                    <td>${progress}%</td>
                    <td><button data-subject="${subject}">Start Challenge</button></td>
                `;
                tbody.appendChild(tr);
            });
            tbody.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', () => startTopicChallenge(btn.dataset.subject));
            });
            checkAchievements();
        }

        function startTopicChallenge(subject) {
            const taskId = generateTaskId();
            gameState.tasks.set(taskId, {
                id: taskId,
                name: `Solve 10 ${subject} questions`,
                deadline: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(),
                difficulty: 'medium',
                coinReward: 20,
                created: new Date().toISOString(),
                subjectBoost: subject
            });
            addNotification(`Topic Challenge Started: ${subject}`);
            saveGameState();
            updateUI();
        }

        function checkAchievements() {
            gameState.subjects.forEach((progress, subject) => {
                if (progress >= 80 && !gameState.achievements.includes(`${subject} Master`)) {
                    gameState.achievements.push(`${subject} Master`);
                    addCoins(100);
                    addNotification(`Achievement Unlocked: ${subject} Master!`);
                }
            });
        }

        document.getElementById('toggle-knowledge-tree').addEventListener('click', () => {
            const table = document.getElementById('targets-table');
            const canvas = document.getElementById('knowledge-tree');
            if (table.style.display !== 'none') {
                table.style.display = 'none';
                canvas.style.display = 'block';
                drawKnowledgeTree();
            } else {
                table.style.display = 'table';
                canvas.style.display = 'none';
            }
        });

        function drawKnowledgeTree() {
            const canvas = document.getElementById('knowledge-tree');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.beginPath();
            ctx.moveTo(canvas.width / 2, canvas.height);
            ctx.lineTo(canvas.width / 2, canvas.height / 2);
            let i = 0;
            gameState.subjects.forEach((progress, subject) => {
                const angle = (i * Math.PI / 3) - Math.PI / 2;
                const x = canvas.width / 2 + Math.cos(angle) * 100;
                const y = canvas.height / 2 + Math.sin(angle) * 100;
                ctx.moveTo(canvas.width / 2, canvas.height / 2);
                ctx.lineTo(x, y);
                ctx.fillStyle = progress >= 80 ? 'green' : 'gray';
                ctx.beginPath();
                ctx.arc(x, y, 10, 0, 2 * Math.PI);
                ctx.fill();
                ctx.fillStyle = 'black';
                ctx.fillText(subject, x - 20, y - 15);
                i++;
            });
            ctx.stroke();
        }

        // Test Marks Graph
        document.getElementById('add-mark-form').addEventListener('submit', e => {
            e.preventDefault();
            const score = parseInt(document.getElementById('test-mark').value);
            const total = parseInt(document.getElementById('test-total').value);
            gameState.marks.push({ score, total, date: new Date().toISOString() });
            if (gameState.goalScore && score >= gameState.goalScore) {
                addCoins(200);
                gameState.achievements.push('Goal Achiever');
                addNotification('Goal Achieved!');
                gameState.goalScore = null;
            }
            if (gameState.marks.length >= 3) checkGraphBadges();
            document.getElementById('add-mark-form').reset();
            saveGameState();
            updateUI();
        });

        document.getElementById('set-goal').addEventListener('click', () => {
            gameState.goalScore = parseInt(document.getElementById('goal-score').value);
            addNotification(`Goal Set: ${gameState.goalScore}`);
            saveGameState();
            updateUI();
        });

        function renderGraph() {
            const canvas = document.getElementById('marks-graph');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (gameState.marks.length === 0) return;
            const maxScore = Math.max(...gameState.marks.map(m => m.total));
            const stepX = canvas.width / (gameState.marks.length - 1 || 1);
            ctx.beginPath();
            ctx.moveTo(0, canvas.height - (gameState.marks[0].score / maxScore) * canvas.height);
            gameState.marks.forEach((mark, i) => {
                const y = canvas.height - (mark.score / maxScore) * canvas.height;
                ctx.lineTo(i * stepX, y);
            });
            ctx.strokeStyle = 'blue';
            ctx.stroke();
            if (gameState.marks.length > 1) {
                const avg = gameState.marks.reduce((sum, m) => sum + m.score / m.total, 0) / gameState.marks.length;
                document.getElementById('score-prediction').textContent = Math.round(avg * maxScore);
            }
        }

        function checkGraphBadges() {
            const lastThree = gameState.marks.slice(-3);
            if (lastThree.length === 3 && lastThree[0].score < lastThree[1].score && lastThree[1].score < lastThree[2].score) {
                if (!gameState.achievements.includes('Rising Star')) {
                    gameState.achievements.push('Rising Star');
                    addCoins(50);
                    addNotification('Achievement Unlocked: Rising Star!');
                }
            }
        }

        // Schedule
        document.getElementById('add-schedule-form').addEventListener('submit', e => {
            e.preventDefault();
            const time = document.getElementById('schedule-time').value;
            const activity = document.getElementById('schedule-activity').value;
            const duration = parseInt(document.getElementById('schedule-duration').value);
            gameState.schedule.push({ time, activity, duration });
            document.getElementById('add-schedule-form').reset();
            scheduleTaskIntegration();
            saveGameState();
            updateUI();
        });

        function renderSchedule() {
            const tbody = document.getElementById('schedule-body');
            tbody.innerHTML = '';
            gameState.schedule.forEach((block, i) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${block.time}</td>
                    <td>${block.activity}</td>
                    <td>${block.duration} min</td>
                    <td><button data-index="${i}">Complete</button></td>
                `;
                tbody.appendChild(tr);
            });
            tbody.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', () => {
                    const i = parseInt(btn.dataset.index);
                    addCoins(10);
                    gameState.schedule.splice(i, 1);
                    saveGameState();
                    updateUI();
                });
            });
        }

        function scheduleTaskIntegration() {
            gameState.tasks.forEach(task => {
                if (!task.scheduled) {
                    const duration = { easy: 30, medium: 60, hard: 90 }[task.difficulty];
                    gameState.schedule.push({ time: new Date(task.deadline).toTimeString().slice(0, 5), activity: task.name, duration });
                    task.scheduled = true;
                }
            });
        }

        // Pomodoro Timer
        let pomodoroInterval;
        document.getElementById('start-pomodoro').addEventListener('click', () => {
            if (gameState.pomodoro.active) return;
            gameState.pomodoro.active = true;
            gameState.pomodoro.timeLeft = 25 * 60;
            gameState.pomodoro.break = false;
            pomodoroInterval = setInterval(() => {
                gameState.pomodoro.timeLeft--;
                if (gameState.pomodoro.timeLeft <= 0) {
                    clearInterval(pomodoroInterval);
                    if (!gameState.pomodoro.break) {
                        addCoins(20);
                        gameState.pomodoro.timeLeft = 5 * 60;
                        gameState.pomodoro.break = true;
                        addNotification('Pomodoro Complete! Take a break.');
                        pomodoroInterval = setInterval(() => {
                            gameState.pomodoro.timeLeft--;
                            if (gameState.pomodoro.timeLeft <= 0) {
                                clearInterval(pomodoroInterval);
                                gameState.pomodoro.active = false;
                                addNotification('Break Over!');
                            }
                            updatePomodoroDisplay();
                        }, 1000);
                    }
                }
                updatePomodoroDisplay();
            }, 1000);
        });

        document.getElementById('stop-pomodoro').addEventListener('click', () => {
            clearInterval(pomodoroInterval);
            gameState.pomodoro.active = false;
            updatePomodoroDisplay();
        });

        function updatePomodoroDisplay() {
            const minutes = Math.floor(gameState.pomodoro.timeLeft / 60);
            const seconds = gameState.pomodoro.timeLeft % 60;
            document.getElementById('timer-display').textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        }

        // Notifications
        function addNotification(message) {
            gameState.notifications.push({ message, id: Date.now() });
            setTimeout(() => {
                gameState.notifications = gameState.notifications.filter(n => n.id !== Date.now());
                renderNotifications();
            }, 5000);
            renderNotifications();
        }

        function renderNotifications() {
            const div = document.getElementById('notifications');
            div.innerHTML = '';
            gameState.notifications.forEach(n => {
                const p = document.createElement('div');
                p.className = 'notification';
                p.textContent = n.message;
                div.appendChild(p);
            });
        }

        // Analytics
        function getAnalytics() {
            const weakSubject = Array.from(gameState.subjects.entries()).sort((a, b) => a[1] - b[1])[0];
            addNotification(`Focus on ${weakSubject[0]} (Progress: ${weakSubject[1]}%)`);
        }

        // Dashboard Toggle with 'Z'
        let dashboardVisible = false;
        document.addEventListener('keydown', (e) => {
            if (e.key.toLowerCase() === 'z') {
                dashboardVisible = !dashboardVisible;
                document.getElementById('dashboard').style.display = dashboardVisible ? 'block' : 'none';
            }
        });

        // Event Listeners
        document.getElementById('targets-btn').addEventListener('click', () => {
            document.getElementById('targets-popup').style.display = 'block';
        });
        document.getElementById('schedule-btn').addEventListener('click', () => {
            document.getElementById('schedule-popup').style.display = 'block';
            scheduleTaskIntegration();
        });
        document.getElementById('close-targets').addEventListener('click', () => {
            document.getElementById('targets-popup').style.display = 'none';
        });
        document.getElementById('close-schedule').addEventListener('click', () => {
            document.getElementById('schedule-popup').style.display = 'none';
        });
        document.getElementById('shop-link').addEventListener('click', () => {
            document.getElementById('shop').scrollIntoView();
            document.getElementById('dashboard').style.display = 'none';
            dashboardVisible = false;
        });
        document.getElementById('schedule-link').addEventListener('click', () => {
            document.getElementById('schedule-popup').style.display = 'block';
            scheduleTaskIntegration();
            document.getElementById('dashboard').style.display = 'none';
            dashboardVisible = false;
        });
        document.getElementById('targets-link').addEventListener('click', () => {
            document.getElementById('targets-popup').style.display = 'block';
            document.getElementById('dashboard').style.display = 'none';
            dashboardVisible = false;
        });

        // Initialize
        loadGameState();
        updateUI();
        setInterval(() => {
            gameState.tasks.forEach(task => {
                if (new Date(task.deadline) < new Date()) {
                    addNotification(`Task "${task.name}" is overdue!`);
                }
            });
            getAnalytics();
        }, 60000); // Check every minute
    </script>
</body>
</html>
